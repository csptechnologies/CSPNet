;This is the boilerplates for connecting your PBX into CSPNet. Please review the boilerplates carefully and adjust them to your needs. 
[globals]
cspkey=longkeyyougotfrommodmail
cspnum=yourofficecode

[from-csp]
exten => _277XXXX/_NXXXXXX,1,NoOp() ; change 277 to your number block
 same => n,Set(lookup=${CURL(https://api.csptech.org/index.php?auth=${cspkey}&number=${CALLERID(num)}&ani=${cspnum}0000)})
 same => n,Set(rawhost=${CUT(lookup,@,2)})
 same => n,Set(host=${CUT(rawhost,:,1)})
 same => n,Set(is_ip=${REGEX("^[0-9]{1,3}(\.[0-9]{1,3}){3}$" ${host})})
 same => n,Set(lookup_cmd=/usr/bin/nslookup ${host} | grep 'Address' | tail -n1 | awk '{print $2}' | tr -d '\n')
 same => n,Set(resolvedhost=${IF($["${is_ip}"="1"]?${host}:${SHELL(${lookup_cmd})})})
 same => n,Set(resolvedhost=${STRREPLACE(resolvedhost, ,\n)})
 same => n,GotoIf($["${resolvedhost}"="${TRUSTED_IP}"]?check_cid)
 same => n,GotoIf($["${resolvedhost}"="${CHANNEL(peerip)}"]?ValidCall:InvalidCall)
 same => n(check_cid),NoOp(CID accepted after IP verification)
 same => n,Goto(ValidCall)
 same => n(ValidCall),Goto(from-internal,${EXTEN:3},1)
 same => n(InvalidCall),NoOp()
 same => n,Set(lookupMsg=${IF($["${resolvedhost}"=""]?"${CALLERID(num)} is not associated with a block on CSPNet":"${CALLERID(num)} is associated with ${resolvedhost}")})
 same => n,Log(NOTICE, Blocked a spoofed call from ${CHANNEL(peerip)} presenting as ${CALLERID(num)} from CSPNet. ${lookupMsg}.)
 same => n,Progress()
 same => n,Wait(2)
 same => n,Playback(custom/cnet-blockedspoofing,noanswer) ;replace with audio file that tells spoofer to fuck off
 same => n,Wait(2)
 same => n,Playback(custom/cnet-blockedspoofing,noanswer) ;replace with audio file that tells spoofer to fuck off
 same => n,Congestion()
 same => n,Hangup()

exten => _277XXXX/_+1NXXNXXXXXX,1,NoOp() ; change 277 to your number block
 same => n,GotoIf($["68.180.38.252"="${CHANNEL(peerip)}"]?CSPVerify:InvalidCall)
 same => n(CSPVerify),Goto(from-internal,${EXTEN:3},1)
 same => n(InvalidCall),NoOp()
 same => n,Set(lookupMsg=${IF($["${resolvedhost}"=""]?"${CALLERID(num)} is not associated with a block on CSPNet":"${CALLERID(num)} is associated with ${resolvedhost}")})
 same => n,Log(NOTICE, Blocked a spoofed call from ${CHANNEL(peerip)} presenting as ${CALLERID(num)} from CSPNet. ${lookupMsg}.)
 same => n,Progress()
 same => n,Wait(2)
 same => n,Playback(custom/cnet-blockedspoofing,noanswer) ;replace with audio file that tells spoofer to fuck off
 same => n,Wait(2)
 same => n,Playback(custom/cnet-blockedspoofing,noanswer) ;replace with audio file that tells spoofer to fuck off
 same => n,Congestion()
 same => n,Hangup()

[from-internal-additional-custom]
;uncomment for prefix dialing into CSPNet
; Change 91 to your prefix for CSPNet
;exten => _91XXXXXXX,1,NoOp() 
; same => n,Set(CALLERID(num)=277${CALLERID(num)})
; same => n,Set(lookup=${CURL(https://api.csptech.org/index.php?auth=${cspkey}&number=${EXTEN:2}&ani=${cspnum}0000)})
; same => n,GotoIf($["${lookup}" = ""]?fail)
; same => n,Dial(${lookup})
; same => n,Hangup()
; same => n(fail),Congestion()
; same => n,Hangup() 

;uncomment for 7 digit dialing into CSPNet 
;exten => _XXXXXXX,1,NoOp() 
; same => n,Set(CALLERID(num)=277${CALLERID(num)}) ;Change 277 to your office code
; same => n,Set(lookup=${CURL(https://api.csptech.org/index.php?auth=${cspkey}&number=${EXTEN}&ani=${cspnum}0000)})
; same => n,GotoIf($["${lookup}" = ""]?fail)
; same => n,Dial(${lookup})
; same => n,Hangup()
; same => n(fail),Congestion()
; same => n,Hangup() 

;uncomment for US PSTN Access Via CSPNet (yes we provide outbound PSTN Access)
;exten => _1NXXNXXXXXX,1,NoOp() 
; same => n,Set(CALLERID(num)=277${CALLERID(num)}) ;Change 277 to your office code
; same => n,Set(lookup=${CURL(https://api.csptech.org/usoutbound/index.php?auth=${cspkey}&number=${EXTEN}&ani=${cspnum}0000)})
; same => n,GotoIf($["${lookup}" = ""]?fail)
; same => n,Dial(${lookup})
; same => n,Hangup()
; same => n(fail),Playback(goodbye)
; same => n,Hangup()
